<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"sniffer.site","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances livere","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"1POSCBVZ02","apiKey":"bf09f0197d475fa69488099407011316","indexName":"getstarted_actors","hits":{"per_page":10}}}</script><script src="/js/config.js"></script>

    <meta name="description" content="TCP(Transmission Control Protocol)即传输控制协议, 位于TCP&#x2F;IP协议栈的第三层传输层, 与UDP不同的是, TCP号称提供有链接的(connection-oriented), 可靠的(reliable)字节流服务, 很多其他应用层协议如HTTP&#x2F;SMTP&#x2F;MQTT都是基于TCP协议实现. 这篇文章我们就从定义的角度来看一看TCP协">
<meta property="og:type" content="article">
<meta property="og:title" content="聊一聊TCP协议">
<meta property="og:url" content="https://sniffer.site/2019/07/30/%E8%81%8A%E4%B8%80%E8%81%8ATCP%E5%8D%8F%E8%AE%AE/index.html">
<meta property="og:site_name" content="JasonWang&#39;s Blog">
<meta property="og:description" content="TCP(Transmission Control Protocol)即传输控制协议, 位于TCP&#x2F;IP协议栈的第三层传输层, 与UDP不同的是, TCP号称提供有链接的(connection-oriented), 可靠的(reliable)字节流服务, 很多其他应用层协议如HTTP&#x2F;SMTP&#x2F;MQTT都是基于TCP协议实现. 这篇文章我们就从定义的角度来看一看TCP协">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sniffer-site.oss-cn-shenzhen.aliyuncs.com/tcp-mss.png">
<meta property="og:image" content="https://sniffer-site.oss-cn-shenzhen.aliyuncs.com/how_rto_calculated.png">
<meta property="og:image" content="https://sniffer-site.oss-cn-shenzhen.aliyuncs.com/tcpswwindows.png">
<meta property="og:image" content="https://sniffer-site.oss-cn-shenzhen.aliyuncs.com/tcpswaftersendnow.png">
<meta property="og:image" content="https://sniffer-site.oss-cn-shenzhen.aliyuncs.com/tcpswflow.png">
<meta property="article:published_time" content="2019-07-30T06:01:35.000Z">
<meta property="article:modified_time" content="2022-03-16T04:42:51.637Z">
<meta property="article:author" content="Jason Wang">
<meta property="article:tag" content="TCP">
<meta property="article:tag" content="拥塞控制">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sniffer-site.oss-cn-shenzhen.aliyuncs.com/tcp-mss.png">


<link rel="canonical" href="https://sniffer.site/2019/07/30/%E8%81%8A%E4%B8%80%E8%81%8ATCP%E5%8D%8F%E8%AE%AE/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://sniffer.site/2019/07/30/%E8%81%8A%E4%B8%80%E8%81%8ATCP%E5%8D%8F%E8%AE%AE/","path":"2019/07/30/聊一聊TCP协议/","title":"聊一聊TCP协议"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>聊一聊TCP协议 | JasonWang's Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">JasonWang's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">本色做人，角色做事</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-materials"><a href="/materials/" rel="section"><i class="fa fa-book fa-fw"></i>资料</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%95%E6%97%B6%E9%87%8D%E4%BC%A0"><span class="nav-number">1.</span> <span class="nav-text">何时重传</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6-%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6%E5%8F%91%E9%80%81%E9%80%9F%E7%8E%87"><span class="nav-number">2.</span> <span class="nav-text">流量控制: 如何控制发送速率</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Silly-Window-Syndrome"><span class="nav-number">2.1.</span> <span class="nav-text">Silly Window Syndrome</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6"><span class="nav-number">3.</span> <span class="nav-text">拥塞控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%85%A2%E5%90%AF%E5%8A%A8"><span class="nav-number">3.1.</span> <span class="nav-text">慢启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8B%A5%E5%A1%9E%E9%81%BF%E5%85%8D"><span class="nav-number">4.</span> <span class="nav-text">拥塞避免</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E9%87%8D%E4%BC%A0%E4%B8%8E%E5%BF%AB%E9%80%9F%E6%81%A2%E5%A4%8D"><span class="nav-number">5.</span> <span class="nav-text">快速重传与快速恢复</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-number">6.</span> <span class="nav-text">参考文献</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jason Wang"
      src="/images/gallaxy.jpg">
  <p class="site-author-name" itemprop="name">Jason Wang</p>
  <div class="site-description" itemprop="description">关于编程,生活,工作</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">92</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">194</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/runningforlife" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;runningforlife" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wlh2119@gmail.com" title="E-Mail → mailto:wlh2119@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/runningforlife" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sniffer.site/2019/07/30/%E8%81%8A%E4%B8%80%E8%81%8ATCP%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gallaxy.jpg">
      <meta itemprop="name" content="Jason Wang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JasonWang's Blog">
      <meta itemprop="description" content="关于编程,生活,工作">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="聊一聊TCP协议 | JasonWang's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          聊一聊TCP协议
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-07-30 14:01:35" itemprop="dateCreated datePublished" datetime="2019-07-30T14:01:35+08:00">2019-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" itemprop="url" rel="index"><span itemprop="name">网络协议</span></a>
        </span>
    </span>

  
    <span id="/2019/07/30/%E8%81%8A%E4%B8%80%E8%81%8ATCP%E5%8D%8F%E8%AE%AE/" class="post-meta-item leancloud_visitors" data-flag-title="聊一聊TCP协议" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>
    
    <div class="post-body" itemprop="articleBody">
        <p>TCP(<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">Transmission Control Protocol</a>)即传输控制协议, 位于TCP&#x2F;IP协议栈的第三层传输层, 与UDP不同的是, TCP号称提供有链接的(connection-oriented), 可靠的(reliable)字节流服务, 很多其他应用层协议如HTTP&#x2F;SMTP&#x2F;MQTT都是基于TCP协议实现.</p>
<p>这篇文章我们就从定义的角度来看一看TCP协议的具体工作原理. 首先看下有链接的(<code>connection-oriented</code>)具体含义.</p>
<p>TCP在发送数据之前, 第一件事情就是要在通信的双方建立一个通信的链路, 这个有点像日常生活中的打电话: A向B发起通话请求, B确认后双方建立通信链接才能正式通话. TCP也一样, 在发送任何数据之前必须要建立链接(connection), 这个建立通信链接的过程就是我们常说的”三次握手”；同样, 如果要想结束通信, 也需要有一个挥手的过程(四次挥手).有关TCP链接的建立与关闭可以参考之前的一篇文章(<a href="http://sniffer.site/2019/07/15/TCP%E9%93%BE%E6%8E%A5%E5%BB%BA%E7%AB%8B%E4%B8%8E%E7%8A%B6%E6%80%81%E8%BF%81%E7%A7%BB/">TCP的链接建立与状态迁移</a>). 那么, TCP建立链接主要完成哪几件事情了?</p>
<span id="more"></span>

<ul>
<li>交换双方的<code>ISN(Initial Sequence Number)</code>: ISN的作用(后面在讲重传时会再讲到)是用来确保每个TCP数据包都是唯一的, 接收端如果收到了重复包可以根据每个包的序列号来实现去重</li>
<li>确认发送数据的<code>MSS(Maximum Segment Size)</code>: MSS是TCP能发送的数据的最大值, 通过TCP头中的<code>options</code>交换, 默认值是536, 一般是当前系统MTU(Maximum Transmission Unit)的值减去TCP&#x2F;IP协议头的大小之和(40byte), 其与MTU关系如下图所示</li>
</ul>
<p><img src="https://sniffer-site.oss-cn-shenzhen.aliyuncs.com/tcp-mss.png" alt="MSS vs MTU"></p>
<ul>
<li>接收窗口的大小: 在TCP头中有一个<code>window</code>选项, 用来告诉对端自己接收缓冲区的大小, 这个窗口在拥塞与流量控制中扮演着十分重要的角色, 用于告诉发送方最大可以发送的数据大小</li>
</ul>
<p>通信双方在三次握手完成之后, 都知道了对方的初始序列号(<code>ISN</code>), 接收窗口大小以及MSS, 这样发送方就可以开始愉快的发送数据了. 接着讲第二个方面: TCP是如何做到要数据的可靠(<code>reliable</code>)传输的? 为了实现这一目标,TCP需要解决很多问题: </p>
<ol>
<li><p>数据在网络上丢包了如何办? TCP对于每个数据包都有个定时器, 如果接收方长时间没有回应, 在定时器超是后就会发起重传, 那么如何选择这个定时器的时长? 重传时间(Retransmission Timeout, RTO)太长, 导致数据传输效率太低; RTO太短, 则可能导致重传的数据包太多, 引发更大的网络拥堵.</p>
</li>
<li><p>发送方如何来控制自己数据的发送速率, 确保接收方能够处理的过来. 发送方不能不顾一切的发送数据, 而不管接收方是否有足够的空间来接受数据. 因此, TCP在接收方忙&#x2F;没有足够空间接收数据时都会主动降低发送速度, 让接收方可以有机会及时恢复.这个是TCP流量控制(<code>flow control</code>)需要做的事情.</p>
</li>
<li><p>如果网络发生拥塞, TCP应该如何处理?发送端不能不顾及网络带宽以及拥堵状态而只管发送数据包, 进而影响其他用户正常使用网络.为了体现网络使用的公平性, 确保不同用户能够都能均衡的使用网络, 减少用户之间的相互干扰, TCP通过多种拥塞控制(<code>Congestion Control</code>)手段来减少网络拥堵, 并且在发生拥堵时尝试尽快恢复.</p>
</li>
</ol>
<p>具体说来TCP主要通过如下几个方式来解决上述几个问题:</p>
<ul>
<li>重传时间的计算: 如何实时调整RTO(<code>retransmission timeout</code>)的大小, 确保重传的频率在合适的范围</li>
<li>流量控制(<code>flow control</code>): 通过滑动窗口(<code>sliding window</code>)机制来实现数据发送的流量控制</li>
<li>拥塞控制(<code>Congestion Control</code>): 拥塞控制主要有 (1) 慢启动 ; (2) 拥塞避免； (3) 拥塞发生； (4) 快速恢复. 在后面会一一介绍这几个算法的原理.</li>
</ul>
<h2 id="何时重传"><a href="#何时重传" class="headerlink" title="何时重传"></a>何时重传</h2><p>为了确保数据的可靠传达, TCP每发送一个数据包, 接收方都要回应一个ACK包, 发送方在发送完一个数据包后就会启动一个重传定时器(<code>retransmission timer</code>), 如果在定时器超时后都未能收到对方的ACK包, 就会重传. 那么如何发送方如何知道重传的超时时间(<code>Retransmission Timeout</code>, RTO)? (在TCP的标准协议文档<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc793">RFC793</a>中给出了一个低通滤波的计算方式, 式中<code>alpha</code>一般为0.9, <code>RTT</code>(Round Trip Time)表示测量得到的返程时间, <code>R</code>表示平滑后的RTT:<br>$$R &#x3D; \alpha R + (1 - \alpha)RTT$$</p>
<p>而RTO是在平滑后的RTT乘以一个系数<code>beta</code>(一般取值为2)得到:</p>
<p>$$RTO &#x3D; \beta R$$</p>
<p>按照上述的计算得到RTO, 由于采用低通滤波,因而没有考虑到在网络发生波动(比如网络拥堵, 路由故障等)等情况下RTT变大的情况, 导致不必要的重传, 反而带来更大的网络负载, 导致网络陷入持久的拥堵.针对该问题, Jacobson在1988年提出了一个改进的RTO计算方法(<a target="_blank" rel="noopener" href="https://ee.lbl.gov/papers/congavoid.pdf">链接</a>, 该算法考虑到了由于网络波动导致的延迟, 因此可以更准确的反映网络拥塞状态:</p>
<p><img src="https://sniffer-site.oss-cn-shenzhen.aliyuncs.com/how_rto_calculated.png" alt="rto"></p>
<p>上述公式, <code>MRTT</code>代表实际测量得到的RTT, <code>SRTT</code>表示平滑后的RTT值, D实际表示的是RTT的平均方差(不是平方差), <code>g</code>一般设为1&#x2F;8(0.125), 而<code>h</code>设为0.25.对于发生了重传的情况, RTO一般会通过<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Exponential_backoff">指数回退</a>的方式进行倍乘(Karn and Partridge 1987).</p>
<h2 id="流量控制-如何控制发送速率"><a href="#流量控制-如何控制发送速率" class="headerlink" title="流量控制: 如何控制发送速率"></a><strong>流量控制: 如何控制发送速率</strong></h2><p>收发数据的两端常常在网络带宽以及性能上都存在差异, (快的)发送方如果不控制发送的速度, 可能会让处在慢速网络中的接收方不知所措.因此, 为了实现数据的可靠传输, TCP需要根据接收方的信息及时调整发送速率, 这个控制发送流量的技术就是著名的滑动窗口(<code>sliding window</code>)协议.简单地讲, 滑动窗口是要根据接收方的可用<code>window</code>(TCP缓存)的大小来达到调整接收方流量大小的目的, 下图是一个滑动窗口示意图(图片来自<a target="_blank" rel="noopener" href="http://www.tcpipguide.com/free/t_TCPSlidingWindowAcknowledgmentSystemForDataTranspo-7.htm">TCP&#x2F;IP Guide</a>):</p>
<p><img src="https://sniffer-site.oss-cn-shenzhen.aliyuncs.com/tcpswwindows.png" alt="TCP sliding window"></p>
<p>图中的数据主要分为4个部分:</p>
<ul>
<li>‘#1’: 表示已经发送的数据, 并且收到了ACK</li>
<li>‘#2’: 表示发送了的数据, 但是没有收到ACK确认</li>
<li>‘#3’: 尚未发送的数据(接收方还有空间)</li>
<li>‘#4’: 不可发送的数据(接收方没有足够空间, 无能为力)</li>
</ul>
<p>当发送了部分<code>#3</code>的数据更新后的滑动窗口如下图所示(图片来自<a target="_blank" rel="noopener" href="http://www.tcpipguide.com/free/t_TCPSlidingWindowAcknowledgmentSystemForDataTranspo-7.htm">TCPIP Guide</a>):</p>
<p><img src="https://sniffer-site.oss-cn-shenzhen.aliyuncs.com/tcpswaftersendnow.png" alt="TCP after sliding window"></p>
<p>可以看到此时<code>可用的部分窗口</code>大小变成了0, 后续要等到接收方确认了<code>#2</code>部分的数据后, 窗口才会继续往前滑动.那么TCP协议是如何在数据传输过程中调整窗口大小(<code>window size</code>)的了? 了解TCP协议的人应该记得, 在TCP协议头有一个专门的字段<code>window</code>用于通信的两端来告知对方当前窗口的大小(能接收多少数据), 而通过<code>socket</code>的<code>SO_RCVBUF</code>参数可以来设置通信时接收缓冲区的大小(<a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man7/socket.7.html">socket(7)</a>). 下图是一个接发数据过程通信两端TCP窗口大小的更新过程:</p>
<p><img src="https://sniffer-site.oss-cn-shenzhen.aliyuncs.com/tcpswflow.png" alt="TCP window size update"></p>
<ul>
<li>在发送数据的开始, 接收端会在三次握手时告知发送端自己的<code>window size</code>(图中为360)</li>
<li>随着发送端不断发送数据, 接收端的<code>window</code>会逐渐减少, 直到为0, 此时发送端会暂停发送数据</li>
</ul>
<p>问题来了, 如果接收方的<code>window</code>为0, 要如何处理?对于接收端, 在接收缓冲区可用后(如应用从读取了部分数据), 会发送一个<code>window update</code>的ACK包, 那万一这个ACK在传输过程中丢失了怎么办? 这样就会导致发送端的TCP无法正常关闭, 因此需要通过在发送端每隔一段时间就发送一个<code>Zero Window Probe</code>的探测包, 来获取接收端窗口的状态, 关于ZWP的说明可以参考(<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc1122#page-92">RFC1122</a>)的讨论.</p>
<h3 id="Silly-Window-Syndrome"><a href="#Silly-Window-Syndrome" class="headerlink" title="Silly Window Syndrome"></a><strong>Silly Window Syndrome</strong></h3><p>Silly Window Syndrome(<code>糊涂窗口综合症</code>)的意思是, 接收端的应用可能每次都只拿走很少的一部分(比如几个字节)的数据, 因此每次<code>window update</code>后发送端也只会发送几个字节的数据, 而我们知道, 光TCP+IP两个协议头都需要40个字节的空间,这样的传输效率看起来太低了.针对该问题, 有两种策略:</p>
<ul>
<li><p>如果问题发生在接收端(接收端处理太慢等), 则可以在<code>window</code>小于某个值时, 直接向发送端ACK一个<code>window=0</code>的包, 告诉发送端暂停发送, 等<code>window</code>大于某个值(比如<code>MSS/2</code>)时再发送<code>window update</code>包让发送方继续发送数据;</p>
</li>
<li><p>而如果问题发生在发送方,则可以考虑Nagle在1984年提出的<code>Nagle Algorithm</code><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc896">RFC896</a>: 对于一个TCP连接, 只要还有一个数据包的没有被确认, 就将应用发送的数据缓存下来, 直到接收到该数据包的ACK之后才允许发送新的数据.这样TCP就尽可能的发送”大”的数据包, 而不是发送多个小包, 导致效率降低. 但对于某些交互式应用如<code>Telenet/SSH/Rlogin</code>, 为了避免延时带来的交互延时, 通常需要关闭<code>Nagle</code>算法, 可以通过socket的选项参数<code>TCP_NODELAY</code>来关闭该算法, 从而提升交互体验.</p>
</li>
</ul>
<h2 id="拥塞控制"><a href="#拥塞控制" class="headerlink" title="拥塞控制"></a><strong>拥塞控制</strong></h2><p>TCP的滑动窗口很好的控制了接收端与发送端的包速率,  但并没有考虑到中间网络如路由器&#x2F;交换机拥塞&#x2F;故障引发的网络拥堵, 为了避免网络拥塞引起网络瘫痪(<code>congestion collapse</code>), TCP需要对网络的拥塞信号做出反应(发生丢包&#x2F;包乱序等). 总的说来, TCP的拥塞控制(<code>congestion control</code>)是为了: </p>
<ul>
<li>(1) 尽可能减少拥塞导致的网络瘫痪(如某个路由节点由于不堪重负崩溃或者卡死)；</li>
<li>(2) 网络使用的公平性(<code>faireness</code>): TCP的目标是尽可能使每个网络的使用者都达到比较好的体验, 避免某一个发送端或者接收端过度的占用网络带宽.</li>
</ul>
<p>在RFC5681(<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc5681"><code>TCP Congestion Control</code></a>)中总结了四个拥塞控制算法:</p>
<h3 id="慢启动"><a href="#慢启动" class="headerlink" title="慢启动"></a><strong>慢启动</strong></h3><p>TCP慢启动(<code>slow start</code>)的意思是开始发送数据时, 尽量逐步增加发送的数据量, 而不是最开始就发送一个大的数据包, 这样试探性的发送数据可以减少网络拥塞.为了实现慢启动以及拥塞避免(与慢启动配套的算法, 接下来会讲到), 需要引入两个状态变量: (1) 拥塞窗口(<code>congestion window</code>) <code>cwnd</code>; (2) 慢启动阈值(<code>slow start threshold</code>) <code>ssthresh</code>, 这个阈值用于慢启动与拥塞避免两个算法之间的切换.</p>
<p>慢启动算法的大致步骤如下:</p>
<ol>
<li>将<code>cwnd</code>设为1, 表示一个MSS大小(<a target="_blank" rel="noopener" href="http://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/36640.pdf">目前一般Linux系统都按照Google的建议</a>将该值设为10)</li>
<li>每次接收到一个ACK后, <code>cwnd += 1</code></li>
</ol>
<p>这样收到一个ACK后,<code>cwnd</code>变为2,接着会发出两个MSS的数据包, ACK会变成4, 最终发送的包数量呈指数上升.等到<code>cwnd &gt; ssthresh</code>, 则进入拥塞避免阶段, TCP会根据收发包的丢包重传的情况, 适当调整<code>cwnd</code>的值, 确保不要让网络变得过度拥堵.</p>
<h2 id="拥塞避免"><a href="#拥塞避免" class="headerlink" title="拥塞避免"></a><strong>拥塞避免</strong></h2><p>当<code>cwnd &gt; ssthresh</code>时, TCP进入拥塞避免(<code>congestion avoidance</code>), 此时<code>cwnd</code>会进入线性调整阶段:</p>
<ol>
<li><code>sshthresh</code>的值大小一般初始化为65535(<code>0x7ffffff</code>)</li>
<li>cwnd +&#x3D; 1&#x2F;cwnd(参考[<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc5681]">https://tools.ietf.org/html/rfc5681]</a></li>
<li>每过一个RTT, 则<code>cwnd = cwnd + 1</code></li>
</ol>
<p>当发生RTO重传时, 需要减少<code>sshthresh</code>的值, 同时减少<code>cwnd</code>的值: </p>
<ul>
<li><code>sshthresh = max(FlightSize/2, 2*MSS)</code></li>
<li><code>cwnd = 1</code></li>
</ul>
<p>这样在重传之后TCP又进入了慢启动模式, 逐步增加发送数据包的速率.</p>
<h2 id="快速重传与快速恢复"><a href="#快速重传与快速恢复" class="headerlink" title="快速重传与快速恢复"></a><strong>快速重传与快速恢复</strong></h2><p>先来了解下快速重传(<code>fast restransmition</code>)与快速恢复(<code>fast recovery</code>)的具体含义:</p>
<ul>
<li>快速重传: 在TCP接收到连续3次DACK(<code>duplicate ACK</code>)后, 主动重传丢失的数据包, 而不是等到RTO超时</li>
<li>快速恢复: 当TCP完成快速重传后, 会进入拥塞避免而不是慢启动, 这样确保发送的流量在适当的拥塞之后保持稳定</li>
</ul>
<p>一般来说, 快速重传与快速恢复是同一起实现的, 具体的流程如下:</p>
<ul>
<li>如果连续收到三个DACK包, 则重传丢失的数据包</li>
<li>更新拥塞窗口以及慢启动阈值: <code>sshthresh = max(FlightSize/2, 2*MSS)</code> 以及<code>cwnd = ssthresh + 3 * MSS</code></li>
<li>后续每收到一个DACK, 将拥塞窗口加一: <code>cwnd = cwnd + 1</code></li>
<li>如果收到ACK, 则<code>cwnd = sshthresh</code>, 这样TCP会再次进入拥塞控制</li>
</ul>
<p>实际TCP针对丢包与重传的情况还有很多改善型算法, 详细可以参考<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc5681">RFC5681</a></p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.tcpipguide.com/free/t_TCPWindowSizeAdjustmentandFlowControl-2.htm">TCP流量控制</a></li>
<li><a target="_blank" rel="noopener" href="http://www.tcpipguide.com/free/t_TCPSlidingWindowAcknowledgmentSystemForDataTranspo.htm">TCP滑动窗口</a></li>
<li><a target="_blank" rel="noopener" href="https://coolshell.cn/articles/11609.html">TCP的那些事情, 耗子叔的力作</a></li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc2914">Congestion Control Principles</a></li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7414">TCP roadmap</a></li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc5681">TCP congestion control</a></li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc1122">TCP&#x2F;IP协议的各种问题的总结</a></li>
<li><a target="_blank" rel="noopener" href="https://draveness.me/whys-the-design-tcp-performance/">TCP为什么有性能问题</a></li>
<li><a target="_blank" rel="noopener" href="https://hpbn.co/building-blocks-of-tcp/">https://hpbn.co/building-blocks-of-tcp/</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Jason Wang
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://sniffer.site/2019/07/30/%E8%81%8A%E4%B8%80%E8%81%8ATCP%E5%8D%8F%E8%AE%AE/" title="聊一聊TCP协议">https://sniffer.site/2019/07/30/聊一聊TCP协议/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/TCP/" rel="tag"># TCP</a>
              <a href="/tags/%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6/" rel="tag"># 拥塞控制</a>
          </div>

        
  <div class="post-widgets">
    <div class="wpac-rating-container">
      <div id="wpac-rating"></div>
    </div>
  </div>

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/07/15/TCP%E9%93%BE%E6%8E%A5%E5%BB%BA%E7%AB%8B%E4%B8%8E%E7%8A%B6%E6%80%81%E8%BF%81%E7%A7%BB/" rel="prev" title="TCP链接建立与状态迁移">
                  <i class="fa fa-chevron-left"></i> TCP链接建立与状态迁移
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/09/04/%E8%AF%B4%E8%AF%B4Process-waitfor-%E5%BC%95%E8%B5%B7%E7%9A%84%E8%BF%9B%E7%A8%8B%E9%98%BB%E5%A1%9E%E9%97%AE%E9%A2%98/" rel="next" title="说说Process.waitfor()引起的进程阻塞问题">
                  说说Process.waitfor()引起的进程阻塞问题 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-livere">livere</a></li>
            <li class="tab"><a href="#comment-utterances">utterances</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane livere" id="comment-livere">
              <div class="comments" id="lv-container" data-id="city" data-uid="MTAyMC8yOTM5NS81OTYz"></div>
            </div>
            <div class="tab-pane utterances" id="comment-utterances">
              <div class="comments utterances-container"></div>
            </div>
        </div>
      </div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2016 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason Wang</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
  <script src="https://embed.widgetpack.com/widget.js" async></script>
  <script class="next-config" data-name="rating" type="application/json">{"enable":true,"id":32167,"color":"#fc6423"}</script>
  <script src="/js/third-party/rating.js"></script>
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.12.1/dist/algoliasearch-lite.umd.js" integrity="sha256-gOvJ6W+j+t/cgnnl9iUU3cb6F1WFQGDdtTXhfPjU4bc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.39.0/dist/instantsearch.production.min.js" integrity="sha256-+ZlQZK9m82XOYGFZCIRrPOFh2kDdAGB6e7TjWGvoaSY=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"rVKgtmJD3PpeVCLXgI3MrnXk-gzGzoHsz","app_key":"nj66qROg1RNBE9qxvn1yTFMg","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script src="/js/third-party/comments/livere.js"></script>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"runningforlife/utterances-comment","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
